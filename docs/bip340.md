# Nostr_tossup.Bip340 モジュールの使い方

`lib/bip340.ml` は libsecp256k1 の Schnorr (BIP-340) API を直接叩く薄い OCaml ラッパーです。ライブラリ名が `nostr_tossup` のため、コード上では `Nostr_tossup.Bip340` として参照します。基本的な流れは次のとおりです。

## 前提

- システムに Schnorr 対応の `libsecp256k1` がインストールされていること (`brew install secp256k1` など)。
- `ctypes`, `ctypes-foreign`, `sha` が opam で導入されていること。

## API 一覧

```ocaml
val load_secret : Bytes.t -> keypair
val public_key : keypair -> Bytes.t
val sign : keypair:keypair -> string -> Bytes.t
val verify : pubkey:Bytes.t -> string -> Bytes.t -> bool
```

## サンプル

```ocaml
let () =
  let open Nostr_tossup.Bip340 in
  let secret = Bytes.init 32 (fun _ -> Char.chr 1) in
  let keypair = load_secret secret in
  let pubkey = public_key keypair in
  let message = "hello nostr" in
  let signature = sign ~keypair message in
  assert (verify ~pubkey message signature);
```

- `load_secret` は 32 バイトのシークレットキーから libsecp256k1 の keypair を初期化します。
- `public_key` は Schnorr 用の x-only 公開鍵 (32 バイト) を返します。
- `sign` はメッセージ文字列を SHA-256 でハッシュし、BIP-340 署名 (64 バイト) を返します。
- `verify` は同じ処理で検証を行います。

## エラー処理

libsecp256k1 の戻り値が 1 以外の場合は `Invalid_argument` 例外を投げます。署名や鍵データの長さチェックも同様に `Invalid_argument` です。

必要に応じてこれらの例外を捕捉して使ってください。

## 秘密鍵の設定

`NOSTR_NSEC` 環境変数を `.env` で管理できます。リポジトリに含まれる `.env.example` を `.env` にコピーし、値を更新してください。フォーマットは次のとおりです。

```
NOSTR_NSEC=nsec1...
```

`.env` が無い場合や値が空の場合は警告を出しつつダミー鍵で起動します。
